From 40a1238787cb20be4077363646bf1a44581b3f7c Mon Sep 17 00:00:00 2001
From: Chenyi Qiang <chenyi.qiang@intel.com>
Date: Thu, 24 Mar 2022 15:37:18 +0800
Subject: [PATCH 1262/1418] KVM: TDX: check the return value from
 kvm_vcpu_gfn_to_memslot

Signed-off-by: Chenyi Qiang <chenyi.qiang@intel.com>
---
 arch/x86/kvm/mmu/mmu.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/arch/x86/kvm/mmu/mmu.c b/arch/x86/kvm/mmu/mmu.c
index db38b2ae27ea..a93fa2ce3328 100644
--- a/arch/x86/kvm/mmu/mmu.c
+++ b/arch/x86/kvm/mmu/mmu.c
@@ -3433,6 +3433,9 @@ static void split_private_spte(struct kvm_vcpu *vcpu, u64 *sptep, u64 old_spte)
 
 	gfn = kvm_mmu_page_get_gfn(sp, sptep - sp->spt);
 	slot = kvm_vcpu_gfn_to_memslot(vcpu, gfn);
+	if (WARN_ON(!slot))
+		return;
+
 	rmap_head = gfn_to_rmap(gfn, sp->role.level, slot);
 	__pte_list_remove(sptep, rmap_head);
 
-- 
2.31.1

