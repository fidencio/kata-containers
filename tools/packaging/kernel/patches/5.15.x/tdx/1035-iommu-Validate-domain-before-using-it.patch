From f6b6f8425c14e4b23f65bd121f272ce4abc45a62 Mon Sep 17 00:00:00 2001
From: Fenghua Yu <fenghua.yu@intel.com>
Date: Thu, 10 Feb 2022 16:23:10 -0800
Subject: [PATCH 1035/1418] iommu: Validate domain before using it

Check if a domain is valid before using it.

Signed-off-by: Jacob Pan <jacob.jun.pan@linux.intel.com>
---
 drivers/iommu/dma-iommu.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/iommu/dma-iommu.c b/drivers/iommu/dma-iommu.c
index 95209428145d..d0850a922683 100644
--- a/drivers/iommu/dma-iommu.c
+++ b/drivers/iommu/dma-iommu.c
@@ -192,6 +192,9 @@ ioasid_t iommu_enable_pasid_dma(struct device *dev)
 		return IOASID_DMA_PASID;
 	}
 	dom = iommu_get_domain_for_dev(dev);
+	if (!dom || !dom->ops)
+		return INVALID_IOASID;
+
 	/*
 	 * Use the reserved kernel PASID for all devices. For now,
 	 * there is no need to have different PASIDs for in-kernel use.
-- 
2.31.1

