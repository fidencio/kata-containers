From 349e9cf703316758fde2f9b9d5eda8d6bfb07326 Mon Sep 17 00:00:00 2001
From: Dave Jiang <dave.jiang@intel.com>
Date: Mon, 29 Nov 2021 10:19:38 -0700
Subject: [PATCH 0982/1418] dmaengine: idxd: add max value for ENQCMDS retries

Put a max cap on retries.

Signed-off-by: Dave Jiang <dave.jiang@intel.com>
---
 Documentation/ABI/stable/sysfs-driver-dma-idxd | 1 +
 drivers/dma/idxd/idxd.h                        | 5 +++--
 drivers/dma/idxd/submit.c                      | 1 -
 drivers/dma/idxd/sysfs.c                       | 3 +++
 4 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/Documentation/ABI/stable/sysfs-driver-dma-idxd b/Documentation/ABI/stable/sysfs-driver-dma-idxd
index fd1a611df510..4d3a23eb05b9 100644
--- a/Documentation/ABI/stable/sysfs-driver-dma-idxd
+++ b/Documentation/ABI/stable/sysfs-driver-dma-idxd
@@ -225,6 +225,7 @@ Date		Oct 29, 2021
 KernelVersion:	5.17.0
 Contact:	dmaengine@vger.kernel.org
 Description:	Indicate the number of retires for an enqcmds submission on a shared wq.
+		A max value to set attribute is capped at 64.
 
 What:           /sys/bus/dsa/devices/engine<m>.<n>/group_id
 Date:           Oct 25, 2019
diff --git a/drivers/dma/idxd/idxd.h b/drivers/dma/idxd/idxd.h
index 62b6bf6e07ae..2e764466dd35 100644
--- a/drivers/dma/idxd/idxd.h
+++ b/drivers/dma/idxd/idxd.h
@@ -53,12 +53,13 @@ enum idxd_type {
 #define IDXD_NAME_SIZE		128
 #define IDXD_PMU_EVENT_MAX	64
 
-#define IDXD_ENQCMDS_RETRIES	32
-
 struct idxd_device_ops {
 	 void (*notify_error)(struct idxd_wq *wq);
 };
 
+#define IDXD_ENQCMDS_RETRIES		32
+#define IDXD_ENQCMDS_MAX_RETRIES	64
+
 struct idxd_device_driver {
 	const char *name;
 	enum idxd_dev_type *type;
diff --git a/drivers/dma/idxd/submit.c b/drivers/dma/idxd/submit.c
index 17102fc0d028..c278cc47fc01 100644
--- a/drivers/dma/idxd/submit.c
+++ b/drivers/dma/idxd/submit.c
@@ -125,7 +125,6 @@ static void llist_abort_desc(struct idxd_wq *wq, struct idxd_irq_entry *ie,
 		idxd_dma_complete_txd(found, IDXD_COMPLETE_ABORT, false);
 }
 
-
 /*
  * ENQCMDS typically fail when the WQ is inactive or busy. On host submission, the driver
  * has better control of number of descriptors being submitted to a shared wq by limiting
diff --git a/drivers/dma/idxd/sysfs.c b/drivers/dma/idxd/sysfs.c
index 61351951bdc9..edd8ba6b6f30 100644
--- a/drivers/dma/idxd/sysfs.c
+++ b/drivers/dma/idxd/sysfs.c
@@ -970,6 +970,9 @@ static ssize_t wq_enqcmds_retries_store(struct device *dev, struct device_attrib
 	if (rc < 0)
 		return rc;
 
+	if (retries > IDXD_ENQCMDS_MAX_RETRIES)
+		retries = IDXD_ENQCMDS_MAX_RETRIES;
+
 	wq->enqcmds_retries = retries;
 	return count;
 }
-- 
2.31.1

